# å¤šä»»åŠ¡å­¦ä¹ æ¨¡å‹ï¼šå£°å­¦å›å£°æ¶ˆé™¤(nnAEC)ä¸è¯­éŸ³æ´»åŠ¨æ£€æµ‹(VAD)

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå¤šä»»åŠ¡æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå¯åŒæ—¶æ‰§è¡Œ**å£°å­¦å›å£°æ¶ˆé™¤(nnAEC)**å’Œ**è¯­éŸ³æ´»åŠ¨æ£€æµ‹(VAD)**ã€‚è¯¥æ¨¡å‹åˆ©ç”¨å…±äº«è¡¨å¾æ¥æå‡ä¸¤ä¸ªä»»åŠ¡çš„æ€§èƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ¨¡å‹æ¶æ„](#æ¨¡å‹æ¶æ„)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å®‰è£…](#å®‰è£…)
- [æ•°æ®é¢„å¤„ç†](#æ•°æ®é¢„å¤„ç†)
- [è®­ç»ƒ](#è®­ç»ƒ)
- [è¯„ä¼°](#è¯„ä¼°)
- [å•å…ƒæµ‹è¯•](#å•å…ƒæµ‹è¯•)

## ğŸ¯ æ¦‚è¿°

æœ¬å®ç°æä¾›äº†ä¸¤ç§ä¸åŒçš„å¤šä»»åŠ¡å­¦ä¹ æ¶æ„ï¼š

1. **å…±äº«ä¸»å¹²æ¨¡å‹**ï¼šä½¿ç”¨å…±åŒçš„CRNNä¸»å¹²ç½‘ç»œé…åˆç‹¬ç«‹çš„ä»»åŠ¡å¤´
2. **å±‚æ¬¡åŒ–æ¨¡å‹**ï¼šå…ˆæ‰§è¡ŒVADï¼Œç„¶åä½¿ç”¨VADä¿¡æ¯é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶æŒ‡å¯¼AEC

ä¸¤ç§æ¨¡å‹éƒ½è®¾è®¡ä¸ºæ¨¡å—åŒ–ã€å¯æ‰©å±•å’Œç”Ÿäº§å°±ç»ªçš„ã€‚

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### æ¶æ„Aï¼šå…±äº«ä¸»å¹²æ¨¡å‹

```
è¾“å…¥(AEC/VAD) 
    â†“
ç‰¹å¾æå–å™¨ï¼ˆä»»åŠ¡ç‰¹å®šï¼‰
    â†“
å…±äº«CRNNä¸»å¹²
    â”œâ”€â†’ AECå¤´ â†’ å¢å¼ºè¯­éŸ³å¹…åº¦è°±
    â””â”€â†’ VADå¤´ â†’ è¯­éŸ³æ´»åŠ¨æ¦‚ç‡
```

**ä¸»è¦ç‰¹ç‚¹ï¼š**
- å…±äº«CRNNä¸»å¹²ç”¨äºé€šç”¨ç‰¹å¾æå–
- é’ˆå¯¹ä¸åŒè¾“å…¥é€šé“çš„ç‹¬ç«‹ç‰¹å¾æå–å™¨
- ç‹¬ç«‹çš„ä»»åŠ¡ç‰¹å®šå¤´
- å‚æ•°å…±äº«ä¿ƒè¿›å­¦ä¹ é€šç”¨è¡¨å¾

**æ¶æ„ç»†èŠ‚ï¼š**
- ç‰¹å¾æå–å™¨ï¼š3å±‚CNNï¼ˆ64é€šé“ï¼‰
- ä¸»å¹²ç½‘ç»œï¼š2å±‚CNNï¼ˆ128é€šé“ï¼‰+ 2å±‚åŒå‘LSTMï¼ˆ256éšè—å•å…ƒï¼‰
- AECå¤´ï¼š2å±‚MLP â†’ å¹…åº¦è°±è¾“å‡º
- VADå¤´ï¼š3å±‚MLP â†’ é€å¸§è¯­éŸ³æ¦‚ç‡

### æ¶æ„Bï¼šå±‚æ¬¡åŒ–/æ¸è¿›å¼æ¨¡å‹

```
è¾“å…¥(AEC) â†’ ç‰¹å¾æå–å™¨ â†’ AECä¸»å¹² â†’ æ³¨æ„åŠ›é—¨ â†’ AECå¤´
                                        â†‘
è¾“å…¥(VAD) â†’ ç‰¹å¾æå–å™¨ â†’ VADä¸»å¹² â†’ VADå¤´
                                        â†“
                                    VADå¼•å¯¼
```

**ä¸»è¦ç‰¹ç‚¹ï¼š**
- VADåˆ†æ”¯æå‰å¤„ç†ç‰¹å¾
- VADé¢„æµ‹é€šè¿‡æ³¨æ„åŠ›é—¨æ§æŒ‡å¯¼AEC
- æ¸è¿›å¼ç»†åŒ–ï¼šç²—ç²’åº¦VAD â†’ ç»†ç²’åº¦AEC
- æ³¨æ„åŠ›æœºåˆ¶ä½¿AECèšç„¦äºè¯­éŸ³åŒºåŸŸ

## ğŸ“ é¡¹ç›®ç»“æ„

```
aec-vad/
â”œâ”€â”€ preprocessing/              # æ•°æ®é¢„å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ joint_preprocessor.py   # è”åˆAEC-VADé¢„å¤„ç†å™¨
â”‚   â””â”€â”€ scp_dataset.py          # åŸºäºSCPçš„æ•°æ®é›†
â”œâ”€â”€ models/                     # æ¨¡å‹å®ç°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€ç±»å’Œç»„ä»¶
â”‚   â”œâ”€â”€ shared_backbone.py      # æ¶æ„A
â”‚   â”œâ”€â”€ hierarchical.py         # æ¶æ„B
â”‚   â”œâ”€â”€ losses.py               # æŸå¤±å‡½æ•°
â”‚   â””â”€â”€ metrics.py              # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ audio_utils.py          # éŸ³é¢‘å¤„ç†å·¥å…·
â”‚   â””â”€â”€ scp_utils.py            # SCPæ–‡ä»¶å¤„ç†å·¥å…·
â”œâ”€â”€ tests/                      # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ ...                     # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ train.py                    # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ prepare_data.py             # æ•°æ®é¢„å¤„ç†è„šæœ¬
â”œâ”€â”€ requirements.txt            # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README_CN.md                # æœ¬æ–‡æ¡£
```

## ğŸ”§ å®‰è£…

### ç¯å¢ƒè¦æ±‚

- Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬
- PyTorch 2.0æˆ–æ›´é«˜ç‰ˆæœ¬
- CUDAï¼ˆå¯é€‰ï¼Œç”¨äºGPUè®­ç»ƒï¼‰

### å®‰è£…æ­¥éª¤

1. å…‹éš†ä»“åº“ï¼š
```bash
git clone https://github.com/KaixingDing/aec-vad.git
cd aec-vad
```

2. å®‰è£…ä¾èµ–ï¼š
```bash
pip install -r requirements.txt
```

## ğŸ“Š æ•°æ®é¢„å¤„ç†

### SCPæ•°æ®æ ¼å¼

æœ¬é¡¹ç›®ä½¿ç”¨ç®€åŒ–çš„SCPæ ¼å¼ï¼Œæ‰€æœ‰æ•°æ®è·¯å¾„å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

**SCPæ–‡ä»¶æ ¼å¼ï¼š**
```
# æ¯è¡Œæ ¼å¼: utt_id mic_path far_path near_path vad_path
train_000000 /path/to/mic.wav /path/to/far.wav /path/to/near.wav /path/to/vad.npy
train_000001 /path/to/mic.wav /path/to/far.wav /path/to/near.wav /path/to/vad.npy
...
```

### ç”Ÿæˆè®­ç»ƒæ•°æ®

ä½¿ç”¨ `prepare_data.py` è„šæœ¬ç”Ÿæˆè”åˆè®­ç»ƒæ•°æ®ï¼š

```bash
python prepare_data.py \
    --dns_root /path/to/DNS-Challenge/datasets \
    --librispeech_root /path/to/LibriSpeech \
    --output_dir ./data/processed \
    --num_train 10000 \
    --num_val 1000 \
    --num_test 1000
```

**å‚æ•°è¯´æ˜ï¼š**
- `--dns_root`: DNS-Challengeæ•°æ®é›†è·¯å¾„
- `--librispeech_root`: LibriSpeechæ•°æ®é›†è·¯å¾„
- `--output_dir`: è¾“å‡ºç›®å½•
- `--num_train`: è®­ç»ƒé›†æ ·æœ¬æ•°é‡
- `--num_val`: éªŒè¯é›†æ ·æœ¬æ•°é‡
- `--num_test`: æµ‹è¯•é›†æ ·æœ¬æ•°é‡

### æ•°æ®é¢„å¤„ç†æµç¨‹

è”åˆé¢„å¤„ç†å™¨ `JointAECVADPreprocessor` ä¼šç”ŸæˆåŒ…å«ä»¥ä¸‹å†…å®¹çš„è®­ç»ƒæ ·æœ¬ï¼š

1. **éº¦å…‹é£ä¿¡å·** (`microphone`): æ··åˆä¿¡å· y(t) = s(t) + e(t) + n(t)
2. **è¿œç«¯å‚è€ƒä¿¡å·** (`far_end`): ç”¨äºAECçš„å‚è€ƒä¿¡å·
3. **è¿‘ç«¯çº¯å‡€è¯­éŸ³** (`near_end`): AECä»»åŠ¡çš„ç›®æ ‡è¾“å‡º
4. **VADæ ‡ç­¾** (`vad_labels`): é€å¸§äºŒåˆ†ç±»æ ‡ç­¾ï¼ˆ0=éè¯­éŸ³ï¼Œ1=è¯­éŸ³ï¼‰

æ‰€æœ‰è·¯å¾„å­˜å‚¨åœ¨å•ä¸ª `data.scp` æ–‡ä»¶ä¸­ã€‚

## ğŸš€ è®­ç»ƒ

### Python APIä½¿ç”¨

```python
from preprocessing import create_scp_dataloader
from models import SharedBackboneModel
from models.losses import MultiTaskLoss

# åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_loader = create_scp_dataloader(
    scp_file='./data/processed/train/data.scp',
    batch_size=16,
    shuffle=True,
)

# åˆå§‹åŒ–æ¨¡å‹å’Œè®­ç»ƒç»„ä»¶
model = SharedBackboneModel(n_freqs=257)
criterion = MultiTaskLoss(aec_weight=1.0, vad_weight=1.0)
optimizer = torch.optim.Adam(model.parameters(), lr=1e-3)

# è®­ç»ƒå¾ªç¯
for batch in train_loader:
    # batchåŒæ—¶åŒ…å«AECå’ŒVADæ•°æ®
    aec_output = model(batch['aec']['input'], task='aec')
    vad_output = model(batch['vad']['input'], task='vad')
    
    # è®¡ç®—æŸå¤±
    outputs = {'aec': aec_output, 'vad': vad_output}
    targets = {
        'aec': {'target_mag': batch['aec']['target_mag']},
        'vad': {'target_labels': batch['vad']['target_labels']}
    }
    losses = criterion(outputs, targets)
    
    # åå‘ä¼ æ’­
    optimizer.zero_grad()
    losses['total'].backward()
    optimizer.step()
```

### å¤šä»»åŠ¡æŸå¤±å‡½æ•°

æ€»æŸå¤±æ˜¯åŠ æƒç»„åˆï¼š

```
L_total = Î»_AEC Ã— L_AEC + Î»_VAD Ã— L_VAD

å…¶ä¸­:
  L_AEC = w_mag Ã— L_magnitude + w_sisdr Ã— L_SI-SDR
  L_VAD = Binary Cross-Entropy
```

## ğŸ“ˆ è¯„ä¼°

### AECæŒ‡æ ‡

- **SI-SDR**ï¼ˆå°ºåº¦ä¸å˜ä¿¡å·å¤±çœŸæ¯”ï¼‰ï¼šè¡¡é‡å¢å¼ºè´¨é‡
- **PESQ**ï¼ˆæ„ŸçŸ¥è¯­éŸ³è´¨é‡è¯„ä¼°ï¼‰ï¼šæ„ŸçŸ¥è´¨é‡
- **STOI**ï¼ˆçŸ­æ—¶å®¢è§‚å¯æ‡‚åº¦ï¼‰ï¼šè¯­éŸ³å¯æ‡‚åº¦
- **ERLE**ï¼ˆå›å£°è¿”å›æŸè€—å¢å¼ºï¼‰ï¼šå›å£°æŠ‘åˆ¶

### VADæŒ‡æ ‡

- **å‡†ç¡®ç‡**ï¼šæ€»ä½“åˆ†ç±»å‡†ç¡®æ€§
- **ç²¾ç¡®ç‡**ï¼šé¢„æµ‹ä¸ºè¯­éŸ³ä¸­å®é™…ä¸ºè¯­éŸ³çš„æ¯”ä¾‹
- **å¬å›ç‡**ï¼šå®é™…è¯­éŸ³è¢«æ£€æµ‹å‡ºçš„æ¯”ä¾‹
- **F1åˆ†æ•°**ï¼šç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡

## ğŸ§ª å•å…ƒæµ‹è¯•

è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š

```bash
pytest tests/ -v
```

æ‰€æœ‰æµ‹è¯•ä½¿ç”¨**æ¨¡æ‹Ÿæ•°æ®**ï¼ˆéšæœºç”Ÿæˆçš„å¼ é‡ï¼‰ï¼Œä¸éœ€è¦å®é™…æ•°æ®é›†ã€‚

## ğŸ“ å¼•ç”¨

å¦‚æœæ‚¨åœ¨ç ”ç©¶ä¸­ä½¿ç”¨æ­¤ä»£ç ï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@software{aec_vad_multitask,
  title={å¤šä»»åŠ¡å­¦ä¹ æ¨¡å‹ï¼šå£°å­¦å›å£°æ¶ˆé™¤ä¸è¯­éŸ³æ´»åŠ¨æ£€æµ‹},
  author={ä¸å‡¯æ˜Ÿ},
  year={2025},
  url={https://github.com/KaixingDing/aec-vad}
}
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›æ•™è‚²å’Œç ”ç©¶ç›®çš„ã€‚

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–åé¦ˆï¼Œè¯·åœ¨GitHubä»“åº“ä¸­æäº¤Issueã€‚
